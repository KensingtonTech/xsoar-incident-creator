<!-- Loaded Configuration Name Container -->
<p-card *ngIf="loadedJsonMappingConfigName" header="Loaded Mapping Name">
  
  <div style="margin-top: 1em;">
    <span class="formLabel" style="font-size: 18px;">{{loadedJsonMappingConfigName}}</span>
  </div>

</p-card>



<div class="fieldsForm">

  <!-- Incident Container -->
  <div style="min-width: 0;">

    <p-card header="Incident">

      <!-- Select Incident Type -->
      <div style="margin-top: 0; margin-bottom: 1em;">

        <span
          class="fieldLabel"
          pTooltip="Select an incident type.  This will control which fields are available to you, based on field definitions loaded from Cortex XSOAR.  Changing this will wipe out all selections.">
          Source Incident Type:&nbsp;&nbsp;
        </span>
    
        <p-dropdown
          [options]="incidentTypeItems"
          [(ngModel)]="selectedIncidentType"
          (onChange)="onIncidentTypeChanged($event.value)"
          [filter]="true"
          placeholder="Select an incident type"
          [style]="{'width': '40em'}">
        </p-dropdown>
      
      </div>

      <!-- Menu Bar -->
      <div *ngIf="selectedIncidentType" class="menuContainer">

        <!-- I don't think reset is required for freeform -->
        <!-- <p-button type="button" label="Reset Values" (onClick)="onResetAllFieldValues()" [disabled]="!currentDemistoEndpointInit"></p-button>--> 

        <!-- Add Field Button -->
        <span>

          <p-button type="button" label="Add Field" (onClick)="onAddIncidentFieldClicked()"></p-button>

          <p-toggleButton
            name="shortFieldNames"
            [onLabel]="shortNamesLabel"
            [offLabel]="longNamesLabel"
            [(ngModel)]="displayIncidentFieldShortNames"
            [disabled]="!currentDemistoEndpointInit">
          </p-toggleButton>

          <p-toggleButton
            onLabel="Create Investigation On"
            offLabel="Create Investigation: Off"
            [(ngModel)]="createInvestigation"
            pTooltip="If enabled, this option will cause an investigation to be created along with a new incident.  This means that any playbook associated with the case type will be automatically executed, if the underlying incident type is configured to do so."
            showDelay="750">

          </p-toggleButton>

        </span>

        <!-- Create Incident Button -->
        <button pButton
          type="button"
          label="Create Incident"
          (click)="onCreateIncident()"
          [disabled]="!json || enabledFieldsCount === 0"
          class="ui-button-warning">
        </button>


      </div>

      <!-- Incident Fields -->
      <div *ngIf="selectedIncidentType" class="freeformFieldContainer">

        <div>
          <p-checkbox
            [(ngModel)]="incidentFieldsSelectAllState"
            [binary]="true"
            (onChange)="onToggleAllChosenIncidentFields()">
          </p-checkbox>
        </div>

        <header>Name</header>

        <header>Type</header>

        <header pToolTip="The method by which to map the field's value">Method</header>

        <header>Value</header>

        <div class="valueContainer">

          <header>Actions</header>

          <div class="pi pi-times" style="font-size: 2em;" pTooltip="Delete All" showDelay="750" (click)="onDeleteAllIncidentFielsdClicked()"></div>
          
        </div>

        <ng-container *ngFor="let field of chosenIncidentFields; trackBy: trackByIdentity">

          <freeform-json-row
            *ngIf="![undefined, null].includes(field.value)"
            #incidentFieldRow
            [field]="field"
            (fieldChange)="onFieldChange($event)"
            [displayShortNames]="displayIncidentFieldShortNames"
            (fieldDeleted)="onIncidentFieldRemoved($event)"
            [jsonLoaded]="json !== undefined"
            [json]="json">
          </freeform-json-row>

        </ng-container>
      </div>

    </p-card>
  </div>



  <!-- JSON Container -->
  <div style="min-width: 0;">

    <p-card header="Freeform JSON Data">

      <div *ngIf="!json else ngxJsonViewer">

        <h2 style="color: white;">
          Please upload some JSON data.  It can be any data, as long as it is valid JSON.
        </h2>

        <ng-container *ngTemplateOutlet="jsonUploader"></ng-container>

      </div>
      
      <ng-template #ngxJsonViewer>

        <!-- Menu Bar -->
        <div>
          <!-- Add Field Button -->
          <ng-container *ngTemplateOutlet="jsonUploader"></ng-container>

        </div>
        
        <div style="overflow-x: auto;">

          <ngx-json-viewer
            [json]="json"
            [selectionMode]="selectionMode"
            [selectionModeFieldType]="selectionModeFieldType">
          </ngx-json-viewer>

        </div>

        

      </ng-template>

    </p-card>

  </div>


  <ng-template #jsonUploader>

    <p-fileUpload #fileUpload
      name="myfile[]"
      mode="basic"
      chooseLabel="Upload"
      [customUpload]="true"
      (uploadHandler)="onFreeformJsonUploaded($event, fileUpload)"
      accept=".json,.txt"
      [multiple]="false"
      [auto]="true"
      pTooltip="Import an incident from a JSON file"
      showDelay="750">
    </p-fileUpload>
    
  </ng-template>



</div>






<!-------------- FIELDS MODAL DIALOGS SECTION -------------->



<!-- Add Incident Field Dialog -->
<p-dialog *ngIf="incidentFieldsToAddItems" header="Choose Incident Fields to Add" [(visible)]="displayAddIncidentFieldDialog" [modal]="true" [draggable]="false" [style]="{width: '25em', 'max-height': '75vh'}" styleClass="openDialog">

  <!--<div class="formLabel">Incident Fields to Add</div>-->

  <p-listbox
    #incidentFieldListBox
    [options]="incidentFieldsToAddItems"
    [(ngModel)]="selectedFieldsToAdd"
    [style]="{ 'width': '100%'}"
    [listStyle]="{'height': '50vh'}"
    [multiple]="true"
    [checkbox]="true"
    [filter]="true"
    styleClass="addIncidentFieldListbox">
  </p-listbox>

  <div style="margin-top: .5em; float: right;">

    <p-button label="Add" (onClick)="onAddIncidentFieldsAccept()" [disabled]="!selectedFieldsToAdd || selectedFieldsToAddLen === 0"></p-button>

    <p-button label="Cancel" (onClick)="displayAddIncidentFieldDialog = false"></p-button>

  </div>

</p-dialog>