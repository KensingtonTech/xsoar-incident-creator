<ng-container *ngIf="loggedInUser">

  <div class="formContainer">

    <div class="appHeader">

      <img src="/assets/incident_creator_logo.png" style="margin-top: 1em;">

    </div>


    <!--<div style="margin-top: 1em; margin-right: 1em; float: right;">Logged in as: <span style="font-weight: bold;"> {{loggedInUser.username}}</span></div>-->

    



    <div style="margin-top: 0; margin-bottom: 1em;">This app creates Cortex XSOAR incidents from JSON data, either incident JSON imported from XSOAR or mapped from 3rd-party JSON sources.  The fields to be imported are selectable and editable.  These can be saved in configurations for easy retrieval.</div>



    <!-- XSOAR Servers-->
    <p-card header="XSOAR Servers">

      <h3 style="margin-top: .5em; text-decoration: underline; color: white;">{{currentDemistoEndpointName ? currentDemistoEndpointName : 'No XSOAR servers are defined'}}</h3>


      <div style="margin-top: 1em;">

        <p-button
          label="Select"
          (onClick)="onOpenDemistoServersClicked()"
          styleClass="alignButton">
        </p-button>

        <p-message
          *ngIf="currentDemistoEndpointInit"
          severity="success" text="XSOAR Connected">
        </p-message>

        <p-message
          *ngIf="!currentDemistoEndpointInit"
          severity="error"
          text="XSOAR Not Connected">
        </p-message>



      </div>

    </p-card>


    <!-- File -->
    <p-card header="File" subheader="Load an incident from Cortex XSOAR, upload an incident JSON file, or perform other file and bulk create operations.">

      <div style="margin-top: 1em;">
        
        <!-- <span class="formLabel"> - OR -&nbsp;&nbsp;&nbsp;</span> -->

        <!-- New Mapping -->
        <p-button
          label="New Mapping"
          (onClick)="onNewJsonMappingClicked()">
        </p-button>
        
        <!-- Open -->
        <p-button
          label="Open Incident"
          (onClick)="onOpenClicked()"
          styleClass="alignButton"
          [disabled]="savedIncidentConfigurationsLen === 0"
          pTooltip="Open a saved incident configuration"
          showDelay="750">
        </p-button>
        
        <!-- Load From XSOAR -->
        <p-button
          label="XSOAR Import"
          (onClick)="onLoadFromDemistoClicked()"
          [disabled]="currentDemistoEndpointInit === false"
          pTooltip="Import an incident directly from XSOAR"
          showDelay="750">
        </p-button>
        
        <!-- Upload Incident JSON -->
        <p-fileUpload
          #fileUpload
          name="myfile[]"
          mode="basic"
          chooseLabel="Incident JSON"
          [customUpload]="true"
          (uploadHandler)="onIncidentJsonUploaded($event, fileUpload)"
          accept=".json,.txt"
          [multiple]="false"
          [auto]="true"
          pTooltip="Import an incident from a JSON file"
          showDelay="750">
        </p-fileUpload>

        <!-- Save -->
        <p-button
          label="Save"
          (onClick)="onSaveClicked()"
          [disabled]="!(loadedIncidentConfigId && loadedIncidentConfigName)">
        </p-button>

        <!-- Save As -->
        <p-button
          label="Save As"
          (onClick)="onSaveAsClicked()"
          [disabled]="!saveAsButtonEnabled">
        </p-button>

        <!-- Delete Incident -->
        <p-button
          label="Delete Incidents"
          (onClick)="onDeleteConfigClicked()"
          [disabled]="savedIncidentConfigurationsLen === 0">
        </p-button>

        <!-- Bulk Create -->
        <p-button
          label="Bulk Create"
          (onClick)="onBulkCreateClicked()"
          [disabled]="savedIncidentConfigurationsLen === 0 || demistoEndpointsLen === 0"
          pTooltip="Create incidents of one or more types, and on one or more XSOAR servers"
          showDelay="750">
        </p-button>

        <!-- Bulk Create Results -->
        <p-button
          *ngIf="this.bulkCreateResults.length !== 0"
          label="Bulk Create Results"
          (onClick)="showBulkResultsDialog = true">
        </p-button>

      </div>

    </p-card>


    <!-- Incident Fields UI -->
    <!--
    <incident-fields-ui
      *ngIf="fetchedIncidentFieldDefinitions && showIncidentFieldsUI"
      [loadedIncidentConfigName]="loadedIncidentConfigName"
      [loadedIncidentConfigId]="loadedIncidentConfigId"
      [currentDemistoEndpointName]="currentDemistoEndpointName"
      [currentDemistoEndpointInit]="currentDemistoEndpointInit"
      [fetchedIncidentFieldDefinitions]="fetchedIncidentFieldDefinitions"
      [savedIncidentConfigurations]="savedIncidentConfigurations"
      (saveAsButtonEnabledChange)="saveAsButtonEnabled = $event"
      (savedIncidentConfigurationsChanged)="onSavedIncidentConfigurationsChanged($event)" 
      (messagesReplace)="messagesReplace($event)"
      (messageWithAutoClear)="messageWithAutoClear($event)"
      (reloadFieldDefinitions)="fetchIncidentFieldDefinitions($event)">
    </incident-fields-ui>-->



    <freeform-json-ui
      *ngIf="showJsonMappingUI && fetchedIncidentFieldDefinitions && fetchedIncidentTypes"

      [loadedIncidentConfigName]="loadedIncidentConfigName"
      [loadedIncidentConfigId]="loadedIncidentConfigId"
      [loadDefaultChosenFields]="loadDefaultChosenFields"
      [demistoEndpointsItems]="demistoEndpointsItems"

      [currentDemistoEndpointName]="currentDemistoEndpointName"
      [currentDemistoEndpointInit]="currentDemistoEndpointInit"
      [fetchedIncidentFieldDefinitions]="fetchedIncidentFieldDefinitions"
      [fetchedIncidentTypes]="fetchedIncidentTypes"
      
      (saveAsButtonEnabledChange)="saveAsButtonEnabled = $event"
      [savedIncidentConfigurations]="savedIncidentConfigurations"
      (savedIncidentConfigurationsChanged)="onSavedIncidentConfigurationsChanged($event)"

      [savedJsonConfigurations]="savedJsonConfigurations"
      (messageAdd)="messageAdd($event)"
      (messagesReplace)="messagesReplace($event)"
      (messageWithAutoClear)="messageWithAutoClear($event)"
      (freeformJsonConfigurationsChanged)="getSavedJsonConfigurations()"

      (reloadFieldDefinitions)="fetchIncidentFieldDefinitions($event)">
    </freeform-json-ui>
    
    <div>&nbsp;</div>

  </div>




  
  <!--------------DEMISTO ENDPOINT MODAL DIALOGS SECTION-------------->

  <!-- Select XSOAR Endpoint Dialog -->
  <p-dialog header="XSOAR Servers" [(visible)]="showDemistoEndpointOpenDialog" [modal]="true" [style]="{width: '50%'}" styleClass="bulkCreateDialog">

    <!-- header bar -->
    <div>

      <!-- New -->
      <p-button
        label="New"
        (onClick)="onNewDemistoEndpointClicked()"
        styleClass="alignButton">
      </p-button>

      <!-- Edit -->
      <p-button
        *ngIf="demistoEndpointsLen !== 0"
        label="Edit"
        (onClick)="onEditDemistoEndpoint()"
        styleClass="alignButton"
        [disabled]="!selectedDemistoEndpointName">
      </p-button>

      <!-- Delete -->
      <p-button
        *ngIf="demistoEndpointsLen !== 0"
        label="Delete"
        (onClick)="onDeleteDemistoEndpointClicked()"
        styleClass="alignButton"
        [disabled]="!selectedDemistoEndpointName">
      </p-button>

      <!-- Test -->
      <p-button
        *ngIf="demistoEndpointsLen !== 0"
        label="Test"
        (onClick)="onTestDemistoEndpoint()"
        styleClass="alignButton"
        [disabled]="!selectedDemistoEndpointName">
      </p-button>

      <!-- Default -->
      <p-button
        *ngIf="demistoEndpointsLen !== 0"
        label="Set Default"
        (onClick)="onSetDefaultDemistoEndpoint()"
        styleClass="alignButton"
        [disabled]="!selectedDemistoEndpointName">
      </p-button>

      <!-- Refresh -->
      <p-button
        label="Refresh"
        (onClick)="onRefreshDemistoEndpoints()"
        styleClass="alignButton">
      </p-button>

      <p-message
        *ngIf="currentDemistoEndpointInit"
        severity="success"
        text="XSOAR Connected">
      </p-message>
      
      <p-message
        *ngIf="!currentDemistoEndpointInit"
        severity="error"
        text="XSOAR Not Connected">
      </p-message>

    </div>

    <div style="margin-top: 1em;">

      <span class="formLabel">Current XSOAR Server: </span>

          <span class="formLabel" style="text-decoration: underline;">{{currentDemistoEndpointName ? currentDemistoEndpointName : 'No server is selected'}}</span>

    </div>

    <div style="margin-top: 1em;">

      <span *ngIf="demistoEndpointsLen === 0; else demistoEndpoints" style="font-weight: bold;">No XSOAR servers are defined</span>

    </div>

    <ng-template #demistoEndpoints>

      <div class="formLabel">Select a server</div>

      <p-listbox
        [options]="demistoEndpointsItems"
        [(ngModel)]="selectedDemistoEndpointName"
        [style]="{'width':'100%'}"
        (onDblClick)="onDemistoEndpointSelected()"
        [filter]="true">
      </p-listbox>

    </ng-template>

      <div style="margin-top: .5em; float: right;">

        <p-button
          *ngIf="demistoEndpointsLen !== 0"
          label="Select"
          (onClick)="onDemistoEndpointSelected()"
          [disabled]="!selectedDemistoEndpointName">
        </p-button>

        <p-button
          label="Close"
          (onClick)="showDemistoEndpointOpenDialog = false">
        </p-button>

    </div>

  </p-dialog>



  <!-- Delete Demisto Endpoint Dialog -->
  <p-dialog header="Delete XSOAR Server" [(visible)]="showDeleteDemistoEndpointDialog" [modal]="true" [style]="{width: '50%'}" styleClass="deleteConfigDialog" (onHide)="onDeleteDemistoEndpointHidden()">

    <div class="formLabel">Please confirm deletion of XSOAR server "{{demistoEndpointToDelete}}"</div>

    <div style="margin-top: .5em; float: right;">

      <p-button
        label="Confirm"
        (onClick)="onDeleteDemistoEndpointConfirmed()">
      </p-button>

      <p-button
        label="Cancel"
        (onClick)="showDeleteDemistoEndpointDialog = false">
      </p-button>

    </div>

  </p-dialog>



  <!-- New / Edit Demisto Endpoint Server Dialog -->
  <p-dialog [header]="newDemistoServerDialogMode === 'new' ? 'New XSOAR Server' : 'Edit XSOAR Server'" [(visible)]="showNewDemistoEndpointDialog" [modal]="true" [style]="{width: '500px'}" styleClass="newDemistoEndpointDialog" (onHide)="onNewEditDemistoEndpointHidden()">

    <!--<div style="margin-bottom: .5em;" class="formLabel">Configuration Name</div>-->

    <div style="margin-top: 1.5em;">
      <span class="ui-float-label">
        <input pInputText type="url" id="url" required [(ngModel)]="newDemistoServerUrl" name="url" class="inputDisplay">
        <label for="url">XSOAR Base URL</label>
      </span>
    </div>

    <div style="margin-top: 1.5em;">
      <span class="ui-float-label">
        <input pInputText type="password" id="apiKey" required [(ngModel)]="newDemistoServerApiKey" name="apiKey" size="50" autocomplete="off" class="inputDisplay" standalone>
        <label for="apiKey">API Key</label>
      </span>
    </div>

    <div style="margin-top: 1.5em;">
      <span class="formLabel">Trust Any Certificate&nbsp;&nbsp;</span>
      <p-inputSwitch name="trustAny" [(ngModel)]="newDemistoServerTrustAny" [style]="{'vertical-align' : 'middle' }"></p-inputSwitch>
    </div>

    <div style="margin-top: .5em;">{{newDemistoServerSaveDisabled ? 'This name is already taken' : '&nbsp;'}}</div>

    <div style="margin-top: .5em; float: right;">

      <!-- Test Button -->
      <p-button
        label="Test"
        (onClick)="testDemistoEndpointAdHoc(newDemistoServerUrl, newDemistoServerApiKey, newDemistoServerTrustAny)"
        [disabled]="newEditTestButtonDisabled">
      </p-button>

      <!-- Save Button -->
      <p-button label="Save"
        *ngIf="newDemistoServerDialogMode === 'new'"
        (onClick)="onNewDemistoEndpointSaved()"
        [disabled]="!newDemistoServerUrl || !newDemistoServerApiKey || newDemistoServerSaveDisabled">
      </p-button>

      <!-- Update Button -->
      <p-button
        label="Update"
        *ngIf="newDemistoServerDialogMode === 'edit'"
        (onClick)="onDemistoEndpointUpdated(newDemistoServerUrl)"
        [disabled]="!newDemistoServerUrl || newDemistoServerSaveDisabled">
      </p-button>

      <p-button
        label="Cancel"
        (onClick)="onNewDemistoEndpointCanceled()">
      </p-button>

    </div>

  </p-dialog>






  <!--------------INCIDENT FIELD CONFIG MODAL DIALOGS SECTION-------------->

  <!-- Open Fields Config Dialog -->
  <p-dialog header="Select a Saved Incident" [(visible)]="showOpenDialog" [modal]="true" [style]="{width: '300px'}" [contentStyle]="{'overflow':'visible'}" styleClass="openDialog">

    <div class="formLabel">Configuration to open</div>

    <p-listbox
      [options]="fieldsConfigItems"
      [(ngModel)]="selectedOpenConfig"
      [style]="{'width':'100%'}"
      (onDblClick)="onConfigOpened()"
      [filter]="true">
    </p-listbox>

    <div style="margin-top: .5em;">

      <p-button
        label="Open"
        (onClick)="onConfigOpened()">
      </p-button>

      <p-button
        label="Cancel"
        (onClick)="onOpenCanceled()">
      </p-button>

    </div>

  </p-dialog>
  


  <!-- Delete Saved Incident Dialog -->
  <p-dialog header="Delete Saved Incident" [(visible)]="showDeleteDialog" [modal]="true" [style]="{width: '300px'}" [contentStyle]="{'overflow':'visible'}" styleClass="deleteConfigDialog">

    <div class="formLabel">Configurations to delete</div>

    <p-listbox
      [options]="fieldsConfigItems"
      [(ngModel)]="selectedDeleteConfigs"
      [multiple]="true"
      [filter]="true"
      [checkbox]="true"
      [style]="{'width':'100%'}">
    </p-listbox>

    <div style="margin-top: .5em;">

      <p-button
        label="Delete"
        (onClick)="onDeleteConfigAccepted()">
      </p-button>

      <p-button
        label="Cancel"
        (onClick)="onDeleteConfigCanceled()">
      </p-button>

    </div>

  </p-dialog>



  <!-- Bulk Create Incident Dialog -->
  <p-dialog
    header="Bulk Incident Creation"
    [(visible)]="showBulkCreateDialog"
    [modal]="true"
    [style]="{width: '75%', maxHeight: '75%'}"
    styleClass="bulkCreateDialog">


      <div class="bulkCreateContainer">

        <div class="bulkCreateContainerColumn">

          <div class="formLabel">Select configurations to push to XSOAR</div>

          <p-listbox
            [options]="fieldsConfigItems"
            [(ngModel)]="selectedBulkCreateConfigs"
            [style]="{'width':'100%'}"
            [multiple]="true"
            [checkbox]="true"
            [filter]="true">
          </p-listbox>

        </div>

        <div class="bulkCreateContainerColumn">

          <div class="formLabel">Select XSOAR servers to push to</div>

          <p-listbox
            [options]="demistoEndpointsItems"
            [(ngModel)]="selectedBulkCreateEndpoints"
            [style]="{'width':'100%'}"
            [multiple]="true"
            [checkbox]="true"
            [filter]="true">
          </p-listbox>

        </div>

      </div>

      <div style="margin-top: .5em; float: right;">

        <p-button
          label="Create Incidents"
          (onClick)="onCreateBulkIncidents()"
          [disabled]="selectedBulkCreateConfigs.length === 0 || selectedBulkCreateEndpoints.length === 0">
        </p-button>

        <p-button
          label="Cancel"
          (onClick)="onBulkCreateCanceled()">
        </p-button>

      </div>

  </p-dialog>



  <!-- Bulk Create Incidents Results Dialog -->
  <p-dialog header="Bulk Create Incident Results" [(visible)]="showBulkResultsDialog" [modal]="true" [style]="{width: '75%'}">

    <div class="bulkCreateResults">
      <div class="bulkCreateResultsGridHeader">Config Name</div>
      <div class="bulkCreateResultsGridHeader">XSOAR Server</div>
      <div class="bulkCreateResultsGridHeader">Result</div>
      <div class="bulkCreateResultsGridHeader">Incident ID</div>
      <div class="bulkCreateResultsGridHeader">Comments</div>
      <ng-container *ngFor="let result of bulkCreateResults">

        <div>{{result.configName}}</div>

        <div>{{result.serverId}}</div>

        <div>{{result.success ? 'Success' : 'Failure'}}</div>

        <div *ngIf="result.hasOwnProperty('incidentId')">
        
          <a href="javascript:void(0)" (click)="onClickDemistoInvestigateUrl(result.incidentId, result.serverId)">{{result.incidentId}}</a>

        </div>

        <div *ngIf="!result.hasOwnProperty('incidentId')"></div>

        <div>

          <span *ngIf="result.hasOwnProperty('skippedFields') && result.skippedFields.length !== 0" class="pi pi-info-circle bulkCreateResultsInfoIcon" [pTooltip]="'Fields were skipped: ' + result.skippedFields.join(', ')">
          </span>

        </div>

      </ng-container>

    </div>

    <div style="margin-top: 1em; float: right;">

      <p-button label="OK" (onClick)="showBulkResultsDialog = false"></p-button>

    </div>

  </p-dialog>



  <!-- XSOAR Import Dialog -->
  <p-dialog header="Import Incident from XSOAR" [(visible)]="showLoadFromDemistoDialog" [modal]="true" [style]="{width: '50%'}" styleClass="loadFromDemistoDialog">

    <form #xsoarImportForm="ngForm">

      <div class="bulkCreateContainer">

        <div class="bulkCreateContainerColumn">

          <div class="formLabel" style="margin-bottom: .5em;">Incident number to import</div>

          <input pInputText
            name="demistoIncidentToLoad"
            type="url"
            id="url"
            required
            [(ngModel)]="demistoIncidentToLoad"
            name="url"
            class="inputDisplay">

        </div>

        <div class="bulkCreateContainerColumn">

          <div class="formLabel" style="margin-bottom: .5em;">Select an XSOAR server</div>

          <p-listbox
            name="demistoEndpointToLoadFrom"
            [options]="demistoEndpointsItems"
            [(ngModel)]="demistoEndpointToLoadFrom"
            [style]="{'width':'100%'}"
            [multiple]="false"
            [checkbox]="true"
            [filter]="false">
          </p-listbox>

        </div>

      </div>

      <div style="margin-top: .5em; float: right;">

        <p-button
          type="submit"
          label="Load Incident"
          (onClick)="onLoadFromDemistoAccepted()"
          [disabled]="importFromDemistoAcceptDisabled">
        </p-button>

        <p-button label="Cancel" (onClick)="onLoadFromDemistoCanceled()"></p-button>

      </div>
    </form>

  </p-dialog>



  <!-- Confirmation Dialog -->
  <p-confirmDialog
    [style]="{width: '50vw'}"
    [closeOnEscape]="true"
    [closable]="true">
  </p-confirmDialog>



  <!-- Container for UI Messages -->
  <div class="messagesContainer">

    <p-messages
      [(value)]="messages">
    </p-messages>

  </div>



</ng-container>




<ng-container *ngIf="!loggedInUser">

  <div>
    Logged in user not yet obtained from API
  </div>

</ng-container>


<div
  *ngIf="showFieldMappingSelectionBox"
  class="fieldMappingSelection">
  JSON field selection mode is active.<br><br>
  To cancel, click outside of the JSON area.
</div>